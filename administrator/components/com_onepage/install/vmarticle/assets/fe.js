function updatePrice(el, product_id)
{
	var p = jQuery(el); 
	var formProduct = p.parents("form.product");
	Multiattribs.setproducttype(formProduct,product_id);
}

Multiattribs = {}; 
Multiattribs.setproducttype = function(form, id) {
	form.view = null;
	var datas = form.serialize();
	var prices = form.parents(".productdetails").find(".product-price");
	if (0 == prices.length) {
		prices = jQuery(".price_for_" + id);
	}
	
	datas = datas.split("&view=cart").join(''); 
	datas = datas.split("&task=add").join(''); 
	
	if (typeof window.vmSiteurl == 'undefined') window.vmSiteurl = '/'; 
	if (typeof window.vmLang == 'undefined') window.vmLang = '&lang=en'; 
	
	prices.fadeTo("fast", 0.75);
	
    jQuery.ajax({
        type: "POST",
        cache: false,
        dataType: "json",
        url: window.vmSiteurl + "index.php?&option=com_virtuemart&view=productdetails&task=recalculate&format=json&nosef=1" + window.vmLang,
        data: datas
    }).success(
        function (data, textStatus) {
            prices.fadeTo("fast", 1);
			if (typeof data.basePriceVariant != 'undefined')
			{
			 var myPrice = data.basePriceVariant; 
			 if (myPrice!=0) prices.show().html(myPrice);
			}
			
        }
    );

	return false; // prevent reload
}

if (typeof Virtuemart === "undefined")
	Virtuemart = {};


Virtuemart.setproducttype = function(form, id) {
	form.view = null;
	var datas = form.serialize();
	var prices = form.parents(".productdetails").find(".product-price");
	if (0 == prices.length) {
		prices = jQuery("#productPrice" + id);
	}
	
	datas = datas.split("&view=cart").join('');
	datas = datas.split("&task=add").join('');

	prices.fadeTo("fast", 0.75);
    jQuery.ajax({
        type: "POST",
        cache: false,
        dataType: "json",
        url: window.vmSiteurl + "index.php?&option=com_virtuemart&view=productdetails&task=recalculate&format=json&nosef=1" + window.vmLang,
        data: datas
    }).done(
        function (data, textStatus) {
            prices.fadeTo("fast", 1);
            // Remove previous messages generated by this AJAX call:
            jQuery( "#system-message-container #system-message div.vmprices-message").remove();
            // refresh price
            for (var key in data) {
                var value = data[key];
                // console.log('my datas',key,value);
                if ( key=='messages' ) {
                    // Extract the messages from the returned string, add the vmprices-message class (so the next ajax call
                    // can remove them again) and then move the messages to the original message container.
                    // Things are complicated by the fact that no #system-message element exists if no messages were printed so far
                    var newmessages = jQuery( data[key] ).find("div.alert").addClass("vmprices-message");
                    if (!jQuery( "#system-message-container #system-message").length && newmessages.length) {
                        jQuery( "#system-message-container" ).append( "<div id='system-message'></div>" );
                    }
                    newmessages.appendTo( "#system-message-container #system-message");
                } else { // prices
                    if (value!=0) prices.find("span.Price"+key).show().html(value);
                    else prices.find(".Price"+key).html(0).hide();
                }
            }
        }
    ).error( function(e) { console.log(e); } );

	return false; // prevent reload
}


Virtuemart.cartEffect = function(form) {
	var $ = jQuery ;

	var dat = form.serialize();
	

	dat = dat.split("&task=add").join('&task=addJS');

	
	if(usefancy){

        jQuery.fancybox.showActivity();
	}
    
	if (typeof window.vmLang == 'undefined') window.vmLang = ''; 
	if (typeof window.vmSiteurl == 'undefined') window.vmSiteurl = '/'; 
	
	var aurl = window.vmSiteurl + "index.php?option=com_virtuemart&nosef=1&view=cart&task=addJS&format=json"+window.vmLang+window.Itemid; 
	
	
	
	
    jQuery.ajax({
        type: "POST",
        cache: false,
        dataType: "json",
        url: aurl, 
        data: dat
    }).done(

	function(datas, textStatus) {

		if(datas.stat ==1){
			var txt = datas.msg;
		} else if(datas.stat ==2){
			var txt = datas.msg +"<H4>"+form.find(".pname").val()+"</H4>";
		} else {
			var txt = "<H4>"+vmCartError+"</H4>"+datas.msg;
		}
		if(usefancy){
            jQuery.fancybox({
					"titlePosition" : 	"inside",
					"transitionIn"	:	"fade",
					"transitionOut"	:	"fade",
					"changeFade"    :   "fast",
					"type"			:	"html",
					"autoCenter"    :   true,
					"closeBtn"      :   false,
					"closeClick"    :   false,
					"content"       :   txt
				}
			);
		} else {
            jQuery.facebox.settings.closeImage = closeImage;
            jQuery.facebox.settings.loadingImage = loadingImage;
			//$.facebox.settings.faceboxHtml = faceboxHtml;
            jQuery.facebox({ text: txt }, 'my-groovy-style');
		}


		Virtuemart.productUpdate();
	}).error( function(e) { console.log(e); } );;

}